substitutions:
  _REGION: northamerica-northeast2
  _SERVICE: bot-backend
  _REPO: backend

steps:
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build backend image'
    args: ['build', '-t', '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$SHORT_SHA', './backend']

  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push image'
    args: ['push', '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$SHORT_SHA']

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Deploy to Cloud Run'
    entrypoint: 'bash'
    args:
      - -c
      - |
        gcloud run deploy ${_SERVICE} \
          --image ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$SHORT_SHA \
          --region ${_REGION} \
          --platform managed \
          --allow-unauthenticated \
          --cpu 1 \
          --memory 512Mi \
          --concurrency 80 \
          --max-instances 10 \
          --set-secrets "DATABASE_URL=DATABASE_URL:latest,SECRET_KEY=SECRET_KEY:latest,OPENAI_API_KEY=OPENAI_API_KEY:latest" \
          --set-env-vars DEBUG=false \
          --set-env-vars LOG_LEVEL=INFO

images:
  - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$SHORT_SHA'

options:
  logging: CLOUD_LOGGING_ONLY

